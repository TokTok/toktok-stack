load("@ai_formation_hazel//tools:mangling.bzl", "hazel_library", "hazel_workspace")
load("@rules_cc//cc:defs.bzl", "cc_library")
load("@rules_haskell//haskell:defs.bzl", "haskell_library")
load("@toktok//third_party/haskell:packages.bzl", "packages")

PACKAGE_NAME = "cryptonite"

package(features = ["-layering_check"])

cc_library(
    name = "cbits",
    srcs = glob([
        "cbits/**/*.h",
    ]) + [
        "cbits/aes/generic.c",
        "cbits/aes/gf.c",
        "cbits/aes/x86ni.c",
        "cbits/argon2/argon2.c",
        "cbits/blake2/sse/blake2b.c",
        "cbits/blake2/sse/blake2bp.c",
        "cbits/blake2/sse/blake2s.c",
        "cbits/blake2/sse/blake2sp.c",
        "cbits/cryptonite_aes.c",
        "cbits/cryptonite_blake2b.c",
        "cbits/cryptonite_blake2bp.c",
        "cbits/cryptonite_blake2s.c",
        "cbits/cryptonite_blake2sp.c",
        "cbits/cryptonite_chacha.c",
        "cbits/cryptonite_cpu.c",
        "cbits/cryptonite_md2.c",
        "cbits/cryptonite_md4.c",
        "cbits/cryptonite_md5.c",
        "cbits/cryptonite_pbkdf2.c",
        "cbits/cryptonite_poly1305.c",
        "cbits/cryptonite_rc4.c",
        "cbits/cryptonite_rdrand.c",
        "cbits/cryptonite_ripemd.c",
        "cbits/cryptonite_salsa.c",
        "cbits/cryptonite_scrypt.c",
        "cbits/cryptonite_sha1.c",
        "cbits/cryptonite_sha256.c",
        "cbits/cryptonite_sha3.c",
        "cbits/cryptonite_sha512.c",
        "cbits/cryptonite_skein256.c",
        "cbits/cryptonite_skein512.c",
        "cbits/cryptonite_tiger.c",
        "cbits/cryptonite_whirlpool.c",
        "cbits/cryptonite_xsalsa.c",
        "cbits/curve25519/curve25519-donna.c",
        "cbits/decaf/ed448goldilocks/decaf_all.c",
        "cbits/decaf/ed448goldilocks/eddsa.c",
        "cbits/decaf/ed448goldilocks/scalar.c",
        "cbits/decaf/p448/arch_ref64/f_impl.c",
        "cbits/decaf/p448/f_arithmetic.c",
        "cbits/decaf/p448/f_generic.c",
        "cbits/decaf/utils.c",
        "cbits/ed25519/ed25519.c",
        "cbits/p256/p256.c",
        "cbits/p256/p256_ec.c",
    ],
    copts = [
        "-Dasm=__asm__",
        "-Iexternal/%s/cbits" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/ed25519" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/decaf/include" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/decaf/p448" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/decaf/include/arch_ref64" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/decaf/p448/arch_ref64" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/blake2/ref" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/argon2" % hazel_workspace(PACKAGE_NAME),
        "-Iexternal/%s/cbits/include64" % hazel_workspace(PACKAGE_NAME),
        "-Wno-strict-aliasing",
        "-Wno-unused-variable",
    ],
    textual_hdrs = [
        "cbits/argon2/core.c",
        "cbits/argon2/ref.c",
        "cbits/argon2/thread.c",
        "cbits/cryptonite_hash_prefix.c",
        "cbits/decaf/ed448goldilocks/decaf.c",
        "cbits/decaf/ed448goldilocks/decaf_tables.c",
    ],
)

haskell_library(
    name = PACKAGE_NAME,
    srcs = glob(
        ["Crypto/**/*.hs*"],
        exclude = ["Crypto/Random/Entropy/Windows.hs"],
    ),
    compiler_flags = [
        "-DARCH_IS_LITTLE_ENDIAN",
        "-DARCH_X86_64",
        "-DSUPPORT_RDRAND",
        "-DSUPPORT_SSE",
        "-DWITH_AESNI",
        "-DWITH_ASSERT_ALIGNMENT",
        "-DWITH_PCLMUL",
        "-Wno-deprecations",
        "-Wno-incomplete-uni-patterns",
        "-XTypeOperators",
    ],
    version = packages[PACKAGE_NAME].version,
    visibility = ["//visibility:public"],
    deps = [
        ":cbits",
        hazel_library("base"),
        hazel_library("basement"),
        hazel_library("bytestring"),
        hazel_library("deepseq"),
        hazel_library("ghc-prim"),
        hazel_library("integer-gmp"),
        hazel_library("memory"),
    ],
)
