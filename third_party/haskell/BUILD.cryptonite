load("@ai_formation_hazel//:hazel.bzl", "hazel_library")
load("@io_tweag_rules_haskell//haskell:haskell.bzl", "haskell_library")
load("@toktok//third_party/haskell:packages.bzl", "packages")

cc_library(
    name = "cbits",
    srcs = glob([
        "cbits/**/*.h",
    ]) + [
        "cbits/cryptonite_chacha.c",
        "cbits/cryptonite_salsa.c",
        "cbits/cryptonite_xsalsa.c",
        "cbits/cryptonite_rc4.c",
        "cbits/cryptonite_cpu.c",
        "cbits/p256/p256.c",
        "cbits/p256/p256_ec.c",
        "cbits/cryptonite_blake2s.c",
        "cbits/cryptonite_blake2sp.c",
        "cbits/cryptonite_blake2b.c",
        "cbits/cryptonite_blake2bp.c",
        "cbits/cryptonite_poly1305.c",
        "cbits/cryptonite_sha1.c",
        "cbits/cryptonite_sha256.c",
        "cbits/cryptonite_sha512.c",
        "cbits/cryptonite_sha3.c",
        "cbits/cryptonite_md2.c",
        "cbits/cryptonite_md4.c",
        "cbits/cryptonite_md5.c",
        "cbits/cryptonite_ripemd.c",
        "cbits/cryptonite_skein256.c",
        "cbits/cryptonite_skein512.c",
        "cbits/cryptonite_tiger.c",
        "cbits/cryptonite_whirlpool.c",
        "cbits/cryptonite_scrypt.c",
        "cbits/cryptonite_pbkdf2.c",
        "cbits/ed25519/ed25519.c",
        "cbits/decaf/p448/arch_ref64/f_impl.c",
        "cbits/decaf/p448/f_generic.c",
        "cbits/decaf/p448/f_arithmetic.c",
        "cbits/decaf/utils.c",
        "cbits/decaf/ed448goldilocks/scalar.c",
        "cbits/decaf/ed448goldilocks/decaf_all.c",
        "cbits/decaf/ed448goldilocks/eddsa.c",
        "cbits/curve25519/curve25519-donna.c",
        "cbits/aes/x86ni.c",
        "cbits/aes/generic.c",
        "cbits/aes/gf.c",
        "cbits/cryptonite_aes.c",
        "cbits/blake2/sse/blake2s.c",
        "cbits/blake2/sse/blake2sp.c",
        "cbits/blake2/sse/blake2b.c",
        "cbits/blake2/sse/blake2bp.c",
        "cbits/argon2/argon2.c",
        "cbits/cryptonite_rdrand.c",
    ],
    copts = [
        "-Dasm=__asm__",
        "-Iexternal/haskell_cryptonite/cbits",
        "-Iexternal/haskell_cryptonite/cbits/ed25519",
        "-Iexternal/haskell_cryptonite/cbits/decaf/include",
        "-Iexternal/haskell_cryptonite/cbits/decaf/p448",
        "-Iexternal/haskell_cryptonite/cbits/decaf/include/arch_ref64",
        "-Iexternal/haskell_cryptonite/cbits/decaf/p448/arch_ref64",
        "-Iexternal/haskell_cryptonite/cbits/blake2/ref",
        "-Iexternal/haskell_cryptonite/cbits/argon2",
        "-Wno-unused-variable",
    ],
    textual_hdrs = [
        "cbits/argon2/core.c",
        "cbits/argon2/ref.c",
        "cbits/argon2/thread.c",
        "cbits/decaf/ed448goldilocks/decaf.c",
        "cbits/decaf/ed448goldilocks/decaf_tables.c",
    ],
)

haskell_library(
    name = "cryptonite",
    srcs = glob(
        ["Crypto/**/*.hs*"],
        exclude = ["Crypto/Random/Entropy/Windows.hs"],
    ),
    compiler_flags = [
        "-DARCH_IS_LITTLE_ENDIAN",
        "-DARCH_X86_64",
        "-DSUPPORT_RDRAND",
        "-DSUPPORT_SSE",
        "-DWITH_AESNI",
        "-DWITH_ASSERT_ALIGNMENT",
        "-DWITH_PCLMUL",
    ],
    version = packages["cryptonite"].version,
    visibility = ["//visibility:public"],
    deps = [
        ":cbits",
        hazel_library("base"),
        hazel_library("basement"),
        hazel_library("bytestring"),
        hazel_library("ghc-prim"),
        hazel_library("memory"),
    ],
)
